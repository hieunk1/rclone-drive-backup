name: rclone upload to Google Drive

# Trigger: thủ công và theo lịch
on:
  workflow_dispatch:         # cho phép bấm Run workflow từ UI
    inputs:
      local_path:
        description: 'Local path in the runner to upload (relative to workspace)'
        required: true
        default: 'to_upload'
      remote_path:
        description: 'Remote path on Google Drive (remote_name:path). Example: gdrive_sa:/backups'
        required: true
        default: 'gdrive_sa:backups'
  schedule:
    # CRON chạy theo UTC. Ví dụ dưới: mỗi ngày lúc 00:30 UTC.
    - cron: '30 0 * * *'

jobs:
  rclone-upload:
    runs-on: ubuntu-latest
    env:
      RCLONE_CONFIG_PATH: ${{ runner.temp }}/rclone.conf   # dùng file config tạm trong runner.temp
    steps:
      - name: Checkout (optional, if you upload files from repo)
        uses: actions/checkout@v4

      - name: Show input parameters
        run: |
          echo "local_path=${{ github.event.inputs.local_path || 'to_upload' }}"
          echo "remote_path=${{ github.event.inputs.remote_path || 'gdrive_sa:backups' }}"

      - name: Restore rclone.conf from secret
        run: |
          # create directory for rclone config (some rclone versions look in ~/.config/rclone)
          mkdir -p ~/.config/rclone
          # write secret value to both ~/.config/rclone/rclone.conf and to runner.temp file referenced by env (optional)
          printf '%s\n' "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf
          printf '%s\n' "${{ secrets.RCLONE_CONFIG }}" > "${RCLONE_CONFIG_PATH}"
          chmod 600 ~/.config/rclone/rclone.conf
          chmod 600 "${RCLONE_CONFIG_PATH}"
        # Don't ever echo the secret into logs.

      - name: Restore service account JSON from secret
        run: |
          # Write the SA JSON to /tmp/gdrive-sa.json so rclone can read it
          printf '%s\n' "${{ secrets.GDRIVE_SA_JSON }}" > /tmp/gdrive-sa.json
          chmod 600 /tmp/gdrive-sa.json

      - name: Install rclone
        run: |
          # install script from rclone official site
          curl https://rclone.org/install.sh | sudo bash
          rclone --version

      - name: Verify rclone remote is present
        run: |
          echo "rclone config file used:"
          rclone config file
          echo "List remotes:"
          rclone listremotes
          echo "Show remote (sanity check, will not print secrets):"
          rclone lsd gdrive_sa: || true

      - name: Upload files with rclone (copy)
        run: |
          # inputs (use defaults if not provided)
          LOCAL_PATH="${{ github.event.inputs.local_path || 'to_upload' }}"
          REMOTE_PATH="${{ github.event.inputs.remote_path || 'gdrive_sa:backups' }}"

          echo "Uploading ${LOCAL_PATH} -> ${REMOTE_PATH} ..."
          # If directory does not exist, fail early
          if [ ! -e "${LOCAL_PATH}" ]; then
            echo "ERROR: Local path '${LOCAL_PATH}' does not exist in workspace $(pwd)"
            ls -la
            exit 1
          fi

          # Use --config to force rclone to read the config file we restored
          rclone --config "${RCLONE_CONFIG_PATH}" copy "${LOCAL_PATH}" "${REMOTE_PATH}" --progress --create-dirs --transfers=4 --checkers=8 --drive-chunk-size=64M
        env:
          # ensure rclone picks correct config file
          RCLONE_CONFIG: "${{ secrets.RCLONE_CONFIG }}"

      - name: Cleanup service account JSON
        if: always()
        run: |
          shred -u /tmp/gdrive-sa.json >/dev/null 2>&1 || rm -f /tmp/gdrive-sa.json

      - name: Finish
        run: echo "rclone upload job finished."
